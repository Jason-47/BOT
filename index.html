<!DOCTYPE html>
<html>
<head>
    <title>Fetch Custom Settings and Show Buttons with PKCE</title>
    <style>
        /* Modified style to set initial display state */
        #legacyChatButton, #miawButton {
            padding: 10px 20px;
            margin: 10px;
            display: none;  /* Buttons start hidden */
        }
    </style>
</head>
<body>
    <h2>Custom Setting Value</h2>

    <!-- Added container for buttons -->
    <div id="buttonContainer">
        <button id="legacyChatButton">Legacy Chat</button>
        <button id="miawButton">MIAW</button>
    </div>

    <script>
        // Your Salesforce org's details
        const CLIENT_ID = '3MVG9SHFu79R42RR04Yt5fB5mocrKgSrjsFwsIlrVzFh9co4ulBSufJOqGZAPNnZs67z28GRqcDuHNHavdZUJ';
        const CLIENT_SECRET = 'C96A75326B8959F050424B364AE27BEF5AAC11EAC238B11D1613F069A8FDD05F';
        const REDIRECT_URI = 'https://jason-47.github.io/BOT';
        const AUTH_URL = 'https://tricore--dev.sandbox.my.salesforce.com/services/oauth2/authorize';
        const TOKEN_URL = 'https://tricore--dev.sandbox.my.salesforce.com/services/oauth2/token';
        const API_URL = '/services/apexrest/settings';

        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            window.crypto.getRandomValues(array);
            return Array.from(array).map(byte => ('0' + byte.toString(16)).slice(-2)).join('');
        }

        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            const base64Digest = btoa(String.fromCharCode.apply(null, new Uint8Array(digest)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
            return base64Digest;
        }

        // Modified showButtons function with console logging
        function showButtons(settingValue) {
            console.log('Showing buttons with setting value:', settingValue);
            
            const legacyButton = document.getElementById('legacyChatButton');
            const miawButton = document.getElementById('miawButton');
            
            // Ensure buttons exist
            if (!legacyButton || !miawButton) {
                console.error('Button elements not found!');
                return;
            }

            const settingIsTrue = settingValue.trim().toLowerCase() === 'true';
            console.log('Setting is true:', settingIsTrue);

            if (settingIsTrue) {
                legacyButton.style.display = 'none';
                miawButton.style.display = 'block';
                console.log('Showing MIAW button');
            } else {
                legacyButton.style.display = 'block';
                miawButton.style.display = 'none';
                console.log('Showing Legacy button');
            }
        }

        // Modified getCustomSetting function with better error handling
        async function getCustomSetting(accessToken) {
            try {
                console.log('Fetching custom setting with token:', accessToken);
                const response = await fetch(API_URL, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.ok) {
                    const settingValue = await response.text();
                    console.log('Received setting value:', settingValue);
                    showButtons(settingValue);
                } else {
                    console.error('Failed to fetch setting:', response.status);
                    // Show legacy button as fallback
                    document.getElementById('legacyChatButton').style.display = 'block';
                }
            } catch (error) {
                console.error('Error fetching custom setting:', error);
                // Show legacy button as fallback
                document.getElementById('legacyChatButton').style.display = 'block';
            }
        }

        // Modified getAccessToken function with error logging
        async function getAccessToken(code) {
            const codeVerifier = sessionStorage.getItem('code_verifier');
            console.log('Getting access token with code verifier:', codeVerifier);

            try {
                const response = await fetch(TOKEN_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `grant_type=authorization_code&code=${code}&client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&code_verifier=${codeVerifier}`
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Received access token');
                    return data.access_token;
                } else {
                    console.error('Failed to get access token:', response.status);
                    return null;
                }
            } catch (error) {
                console.error('Error getting access token:', error);
                return null;
            }
        }

        // Rest of your existing functions...
        async function loginWithSalesforce() {
            const codeVerifier = generateCodeVerifier();
            const codeChallenge = await generateCodeChallenge(codeVerifier);

            sessionStorage.setItem('code_verifier', codeVerifier);

            const authWindow = window.open(
                `${AUTH_URL}?response_type=code&client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&code_challenge=${codeChallenge}&code_challenge_method=S256`,
                'authWindow',
                'width=800,height=600'
            );

            window.addEventListener('message', async function(event) {
                if (event.origin === window.location.origin) {
                    const authorizationCode = event.data;
                    if (authorizationCode) {
                        const accessToken = await getAccessToken(authorizationCode);
                        console.log('Access token received:', !!accessToken);
                        if (accessToken) {
                            getCustomSetting(accessToken);
                        }
                    }
                }
            });
        }

        function handleCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const authorizationCode = urlParams.get('code');
            if (authorizationCode) {
                window.opener.postMessage(authorizationCode, window.location.origin);
                window.close();
            }
        }

        // Modified window.onload with error handling
        window.onload = function() {
            console.log('Page loaded, initiating Salesforce login');
            try {
                loginWithSalesforce();
            } catch (error) {
                console.error('Error during initialization:', error);
                // Show legacy button as fallback
                document.getElementById('legacyChatButton').style.display = 'block';
            }
        };

        // Check if we are on the callback URL
        if (window.location.pathname === '/callback') {
            handleCallback();
        }
    </script>
</body>
</html>
