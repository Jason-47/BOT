<!DOCTYPE html>
<html>
<head>
<title>Fetch Custom Settings and Show Buttons with PKCE</title>
<script>
    // Your Salesforce org's details
    const CLIENT_ID = '3MVG9SHFu79R42RR04Yt5fB5mocrKgSrjsFwsIlrVzFh9co4ulBSufJOqGZAPNnZs67z28GRqcDuHNHavdZUJ';
    const REDIRECT_URI = 'https://tricore--dev.sandbox.lightning.force.com/callback'; 
    const AUTH_URL = 'https://tricore--dev.sandbox.my.salesforce.com/services/oauth2/authorize'; 
    const TOKEN_URL = 'https://tricore--dev.sandbox.my.salesforce.com/services/oauth2/token'; 
    // Updated API URL to include instance URL and API version
    const INSTANCE_URL = 'https://tricore--dev.sandbox.my.salesforce.com';
    const API_VERSION = 'v58.0';
    const API_URL = `${INSTANCE_URL}/services/apexrest/settings/${API_VERSION}`; 

    // Function to generate a random code verifier
    function generateCodeVerifier() {
        const array = new Uint8Array(32);
        window.crypto.getRandomValues(array);
        return Array.from(array).map(byte => ('0' + byte.toString(16)).slice(-2)).join('');
    }

    // Function to generate a code challenge
    async function generateCodeChallenge(verifier) {
        const encoder = new TextEncoder();
        const data = encoder.encode(verifier);
        const digest = await window.crypto.subtle.digest('SHA-256', data);
        const base64Digest = btoa(String.fromCharCode.apply(null, new Uint8Array(digest)))
            .replace(/\+/g, '-')
            .replace(/\//g, '_')
            .replace(/=+$/, '');
        return base64Digest;
    }

    // Function to initiate the OAuth login process
    async function loginWithSalesforce() {
        try {
            const codeVerifier = generateCodeVerifier();
            const codeChallenge = await generateCodeChallenge(codeVerifier);

            sessionStorage.setItem('code_verifier', codeVerifier);

            const authWindow = window.open(
                `${AUTH_URL}?response_type=code&client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&code_challenge=${codeChallenge}&code_challenge_method=S256`,
                'authWindow',
                'width=800,height=600'
            );

            window.addEventListener('message', async function(event) {
                if (event.origin === window.location.origin) {
                    const authorizationCode = event.data;
                    if (authorizationCode) {
                        const tokenResponse = await getAccessToken(authorizationCode);
                        if (tokenResponse && tokenResponse.access_token) {
                            // Store the instance URL from the token response
                            sessionStorage.setItem('instance_url', tokenResponse.instance_url);
                            getCustomSetting(tokenResponse.access_token);
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Login error:', error);
            alert('Error during login process');
        }
    }

    // Updated function to exchange authorization code for an access token
    async function getAccessToken(code) {
        const codeVerifier = sessionStorage.getItem('code_verifier');

        try {
            const response = await fetch(TOKEN_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `grant_type=authorization_code&code=${code}&client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&code_verifier=${codeVerifier}`
            });

            if (!response.ok) {
                throw new Error(`Token request failed: ${response.status}`);
            }

            return await response.json();
        } catch (error) {
            console.error('Error getting access token:', error);
            alert('Failed to get access token: ' + error.message);
            return null;
        }
    }

    // Updated function to call Salesforce API
    async function getCustomSetting(accessToken) {
        try {
            const instanceUrl = sessionStorage.getItem('instance_url') || INSTANCE_URL;
            const response = await fetch(`${instanceUrl}${API_URL}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`API request failed: ${response.status}`);
            }

            const settingValue = await response.text();
            showButtons(settingValue);
        } catch (error) {
            console.error('Error fetching custom setting:', error);
            alert('Failed to fetch setting: ' + error.message);
        }
    }

    function showButtons(settingValue) {
        const settingIsTrue = settingValue.trim().toLowerCase() === 'true';
        
        document.getElementById('legacyChatButton').style.display = settingIsTrue ? 'none' : 'block';
        document.getElementById('miawButton').style.display = settingIsTrue ? 'block' : 'none';
    }

    function handleCallback() {
        const urlParams = new URLSearchParams(window.location.search);
        const authorizationCode = urlParams.get('code');
        if (authorizationCode) {
            window.opener.postMessage(authorizationCode, window.location.origin);
            window.close();
        }
    }

    // Initialize based on current page
    window.onload = function() {
        if (window.location.pathname === '/callback') {
            handleCallback();
        } else {
            loginWithSalesforce();
        }
    };
</script>
<style>
    #legacyChatButton, #miawButton {
        display: none;
    }
</style>
</head>
<body>
<h2>Custom Setting Value</h2>
<button id="legacyChatButton">Legacy Chat</button>
<button id="miawButton">MIAW</button>
</body>
</html>
