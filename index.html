<!DOCTYPE html>
<html>
<head>
    <title>Salesforce Integration with Token Management</title>
    <script>
        // Global variable for storing current access token
        let currentAccessToken = '';

        // Salesforce Configuration
        const CONFIG = {
            tokenUrl: 'https://tricore--dev.sandbox.my.salesforce.com/services/oauth2/token',
            settingsUrl: 'https://tricore--dev.sandbox.my.salesforce.com/services/apexrest/settings',
            params: {
                grant_type: 'password',
                client_id: '3MVG9SHFu79R42RR04Yt5fB5mocrKgSrjsFwsIlrVzFh9co4ulBSufJOqGZAPNnZs67z28GRqcDuHNHavdZUJ',
                client_secret: 'C96A75326B8959F050424B364AE27BEF5AAC11EAC238B11D1613F069A8FDD05F',
                username: 'mailto:ssnappism2@ismsystems.com.dev',
                password: '!Smdemo12345678bjDmgfGAnz4EKCbg9jPCK41t7'
            }
        };

     
        async function refreshAccessToken() {
            try {
                updateStatus('Getting new access token...');
                
                const params = new URLSearchParams(CONFIG.params);
                const response = await fetch(CONFIG.tokenUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: params.toString()
                });

                if (!response.ok) {
                    throw new Error(`Token Error: ${response.status}`);
                }

                const data = await response.json();
                currentAccessToken = data.access_token;
                
             
                document.getElementById('tokenDisplay').value = currentAccessToken;
                updateStatus('New access token received!');
                
                return currentAccessToken;

            } catch (error) {
                updateStatus(`Token Error: ${error.message}`);
                console.error('Token Error:', error);
                throw error;
            }
        }

     
        async function getCustomSetting() {
            try {
                // Pehle naya token lo
                await refreshAccessToken();
                
                updateStatus('Fetching custom setting with new token...');

                const response = await fetch(CONFIG.settingsUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentAccessToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Settings Error: ${response.status}`);
                }

                const settingValue = await response.text();
                updateStatus('Custom setting fetched successfully!');
                return settingValue;

            } catch (error) {
                updateStatus(`Settings Error: ${error.message}`);
                console.error('Settings Error:', error);
                throw error;
            }
        }

      
        function showButtons(settingValue) {
            try {
                const settingIsTrue = settingValue.trim().toLowerCase() === 'true';
                
                const legacyButton = document.getElementById('legacyChatButton');
                const miawButton = document.getElementById('miawButton');

                legacyButton.style.display = settingIsTrue ? 'none' : 'block';
                miawButton.style.display = settingIsTrue ? 'block' : 'none';

                updateStatus(`Current Setting: ${settingValue}`);

            } catch (error) {
                updateStatus(`Button Error: ${error.message}`);
                console.error('Button Error:', error);
            }
        }

      
        async function manualRefresh() {
            try {
                await initialize();
                updateStatus('Manual refresh completed!');
            } catch (error) {
                updateStatus(`Refresh Error: ${error.message}`);
            }
        }

        // Status update karne ka function
        function updateStatus(message) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            console.log(message);
        }

        // Initial setup
        async function initialize() {
            try {
                const settingValue = await getCustomSetting(); // Ye automatically naya token lega
                showButtons(settingValue);
            } catch (error) {
                updateStatus(`Initialization Error: ${error.message}`);
                console.error('Initialization Error:', error);
            }
        }

       
        window.onload = initialize;
    </script>
    <style>
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            font-family: Arial, sans-serif;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        #status {
            margin: 15px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #0070d2;
        }
        .token-display {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 12px 24px;
            margin: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #0070d2;
            color: white;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #005fb2;
        }
        .refresh-btn {
            background-color: #04844b;
        }
        .refresh-btn:hover {
            background-color: #036c3c;
        }
        h2 {
            color: #0070d2;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Salesforce Integration</h2>
        <div id="status">Initializing...</div>
        
        <!-- Token Display Area -->
        <div>
            <h3>Current Access Token:</h3>
            <input type="text" id="tokenDisplay" class="token-display" readonly>
        </div>

        <!-- Manual Refresh Button -->
        <button onclick="manualRefresh()" class="refresh-btn">Refresh Token & Settings</button>

        <!-- Chat Buttons -->
        <div id="buttons">
            <button id="legacyChatButton" style="display: none;">Legacy Chat</button>
            <button id="miawButton" style="display: none;">MIAW</button>
        </div>
    </div>
</body>
</html>
