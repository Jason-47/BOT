<!DOCTYPE html>
<html>
<head>
    <title>Fetch Custom Settings and Show Buttons with PKCE</title>
    <style>
        .button {
            padding: 10px 20px;
            margin: 10px;
            border-radius: 4px;
            cursor: pointer;
            display: none;
        }
        
        .error-message {
            color: red;
            margin: 10px 0;
            display: none;
        }

        .loading {
            display: none;
            margin: 10px 0;
        }
    </style>
    <script>
        // Your Salesforce org's details
        const CONFIG = {
            CLIENT_ID: '3MVG9SHFu79R42RR04Yt5fB5mocrKgSrjsFwsIlrVzFh9co4ulBSufJOqGZAPNnZs67z28GRqcDuHNHavdZUJ',
            REDIRECT_URI: 'https://tricore--dev.sandbox.lightning.force.com/callback',
            AUTH_URL: 'https://tricore--dev.sandbox.my.salesforce.com/services/oauth2/authorize',
            TOKEN_URL: 'https://tricore--dev.sandbox.my.salesforce.com/services/oauth2/token',
            API_URL: '/services/apexrest/settings'
        };

        // Error handling utility
        const ErrorHandler = {
            showError: function(message) {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            },
            clearError: function() {
                document.getElementById('errorMessage').style.display = 'none';
            }
        };

        // PKCE utilities
        const PKCEUtil = {
            generateCodeVerifier: function() {
                const array = new Uint8Array(32);
                window.crypto.getRandomValues(array);
                return Array.from(array)
                    .map(byte => ('0' + byte.toString(16)).slice(-2))
                    .join('');
            },

            async generateCodeChallenge(verifier) {
                const encoder = new TextEncoder();
                const data = encoder.encode(verifier);
                const digest = await window.crypto.subtle.digest('SHA-256', data);
                return btoa(String.fromCharCode.apply(null, new Uint8Array(digest)))
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_')
                    .replace(/=+$/, '');
            }
        };

        // OAuth flow handler
        class OAuthHandler {
            constructor() {
                this.authWindow = null;
            }

            async initializeLogin() {
                try {
                    document.getElementById('loading').style.display = 'block';
                    ErrorHandler.clearError();

                    const codeVerifier = PKCEUtil.generateCodeVerifier();
                    const codeChallenge = await PKCEUtil.generateCodeChallenge(codeVerifier);
                    
                    sessionStorage.setItem('code_verifier', codeVerifier);

                    const authUrl = new URL(CONFIG.AUTH_URL);
                    authUrl.searchParams.append('response_type', 'code');
                    authUrl.searchParams.append('client_id', CONFIG.CLIENT_ID);
                    authUrl.searchParams.append('redirect_uri', CONFIG.REDIRECT_URI);
                    authUrl.searchParams.append('code_challenge', codeChallenge);
                    authUrl.searchParams.append('code_challenge_method', 'S256');

                    this.authWindow = window.open(
                        authUrl.toString(),
                        'authWindow',
                        'width=800,height=600'
                    );

                    if (!this.authWindow) {
                        throw new Error('Popup blocker may be preventing authentication.');
                    }

                    this.setupMessageListener();
                } catch (error) {
                    ErrorHandler.showError(`Authentication initialization failed: ${error.message}`);
                }
            }

            setupMessageListener() {
                window.addEventListener('message', async (event) => {
                    if (event.origin === window.location.origin && event.data) {
                        try {
                            const accessToken = await this.getAccessToken(event.data);
                            if (accessToken) {
                                await this.fetchCustomSetting(accessToken);
                            }
                        } catch (error) {
                            ErrorHandler.showError(`Authentication process failed: ${error.message}`);
                        }
                    }
                });
            }

            async getAccessToken(code) {
                const codeVerifier = sessionStorage.getItem('code_verifier');
                if (!codeVerifier) {
                    throw new Error('Code verifier not found');
                }

                const response = await fetch(CONFIG.TOKEN_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        code: code,
                        client_id: CONFIG.CLIENT_ID,
                        redirect_uri: CONFIG.REDIRECT_URI,
                        code_verifier: codeVerifier
                    })
                });

                if (!response.ok) {
                    throw new Error(`Token request failed: ${response.status}`);
                }

                const data = await response.json();
                return data.access_token;
            }

            async fetchCustomSetting(accessToken) {
                const response = await fetch(CONFIG.API_URL, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch setting: ${response.status}`);
                }

                const settingValue = await response.text();
                this.updateButtonVisibility(settingValue);
            }

            updateButtonVisibility(settingValue) {
                const settingIsTrue = settingValue.trim().toLowerCase() === 'true';
                document.getElementById('legacyChatButton').style.display = settingIsTrue ? 'none' : 'block';
                document.getElementById('miawButton').style.display = settingIsTrue ? 'block' : 'none';
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Callback handler
        function handleCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const authorizationCode = urlParams.get('code');
            const error = urlParams.get('error');

            if (error) {
                ErrorHandler.showError(`Authorization failed: ${error}`);
                return;
            }

            if (authorizationCode) {
                window.opener.postMessage(authorizationCode, window.location.origin);
                window.close();
            }
        }

        // Initialize on page load
        window.onload = function() {
            if (window.location.pathname === '/callback') {
                handleCallback();
            } else {
                const oauthHandler = new OAuthHandler();
                oauthHandler.initializeLogin();
            }
        };
    </script>
</head>
<body>
    <h2>Custom Setting Value</h2>
    <div id="loading" class="loading">Loading...</div>
    <div id="errorMessage" class="error-message"></div>
    <button id="legacyChatButton" class="button">Legacy Chat</button>
    <button id="miawButton" class="button">MIAW</button>
</body>
</html>
